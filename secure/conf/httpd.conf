# Apache configuration for secure.mysociety.org.
#
# Add lines something like this to your main /etc/apache/httpd.conf:
#
# # mySociety services
# <VirtualHost *:80>
#     ServerName services.owl
#     DocumentRoot /home/francis/devel/mysociety/services/web
#     <Directory /home/francis/devel/mysociety/services/web>
#         Include /home/francis/devel/mysociety/services/conf/httpd.conf
#     </Directory>
# </VirtualHost>
#
# You also need to enable .php files and .cgi files to run as PHP
# scripts and CGI scripts respectively.  For example:
#
#  Options +ExecCGI
#  AddHandler cgi-script .cgi
#
# 
# Copyright (c) 2004 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org
# 
# $Id: httpd.conf,v 1.125 2010-11-06 01:05:36 dave Exp $

<Location /fcgi>
    Options +ExecCGI
    SetHandler fastcgi-script
</Location>

RewriteEngine On
RewriteRule ^/favicon.ico$  /favicon.ico [F]

# Redirect any other domain's https accesses to the http ones
RewriteCond %{HTTP_HOST}    !^secure\.mysociety\.org$
RewriteRule ^/([^x]|[x])+$            http://%{HTTP_HOST}%{REQUEST_URI} [R]

# Proxy all the admin pages to pages on their real sites
ProxyPass /admin/fyr/ http://www.writetothem.com/admin/
ProxyPass /admin/fyr-louise/ http://louise.writetothem.com/admin/
ProxyPass /admin/fyr-cities/ http://cities.writetothem.com/admin/

ProxyPass /admin/pb/ http://www.pledgebank.com/admin/
ProxyPass /admin/pb-livesimply/ http://promise.livesimply.org.uk/admin/
ProxyPass /admin/pb-o2/ http://o2.pledgebank.com/admin/
ProxyPass /admin/pb-francis/ http://francis.pledgebank.com/admin/
ProxyPass /admin/pb-matthew/ http://matthew.pledgebank.com/admin/

ProxyPass /admin/ycml/ http://www.hearfromyourmp.com/admin/
ProxyPass /admin/ycml-staging/ http://matthew.hearfromyourmp.com/admin/
ProxyPass /admin/hfyc/ http://www.hearfromyourcouncillor.com/admin/

ProxyPass /admin/foi/ http://www.whatdotheyknow.com/admin/
ProxyPass /admin/foi-public/ http://www.whatdotheyknow.com/
ProxyPass /admin/foi-francis/ http://francis.foi.mysociety.org/admin/
ProxyPass /admin/foi-francis-public/ http://francis.foi.mysociety.org/

ProxyPass /admin/bci/ http://www.fixmystreet.com/admin/
ProxyPass /admin/bci-matthew/ http://matthew.fixmystreet.com/admin/
ProxyPass /admin/bci-louise/ http://louise.fixmystreet.com/admin/
ProxyPass /admin/bci-louise-cities/ http://cities.louise.fixmystreet.com/admin/
ProxyPass /admin/bci-dave/ http://dave.fixmystreet.com/admin/
ProxyPass /admin/bci-dave-cities/ http://cities.dave.fixmystreet.com/admin/
ProxyPass /admin/bci-cities/ http://cities.fixmystreet.com/admin/
ProxyPass /admin/emptyhomes/ http://reportemptyhomes.com/admin/
ProxyPass /admin/gny/ http://www.groupsnearyou.com/admin/

ProxyPass /admin/cvswww/ http://cvs.mysociety.org/admin/
ProxyPass /admin/services/ http://services.mysociety.org/admin/
ProxyPass /admin/services-guardian/ http://guardian.services.mysociety.org/admin/

ProxyPass /admin/lists/ http://lists.mysociety.org/admin/lists/
ProxyPassReverse /admin/lists/ http://lists.mysociety.org/admin/lists/

ProxyPass /cvstrac http://cvs.mysociety.org/cvstrac   
ProxyPass /intranet http://intranet.mysociety.org/intranet

ProxyPass /admin/cacti/ http://cacti.mysociety.org/
ProxyPassReverse /admin/cacti/ http://cacti.mysociety.org/
# compensate for non-relative links in the cacti code
RedirectPermanent /graph_view.php http://secure.mysociety.org/admin/cacti/graph_view.php

ProxyPass /admin/news/ http://news.mysociety.org/admin/
ProxyPass /admin/survey/ http://survey.mysociety.org/admin/

ProxyPass /admin/pet-matthew/ http://matthew.pet.mysociety.org/admin/
ProxyPass /admin/pet-sbdc/ http://sbdc.petitions.mysociety.org/admin/
ProxyPass /admin/pet-staging/ http://staging.pet.mysociety.org/admin/
ProxyPass /admin/pet-testharness/ http://testharness.pet.mysociety.org/admin/
ProxyPass /admin/pet/ http://petitions.number10.gov.uk/admin/
ProxyPass /admin/surrey/ http://petitions.surreycc.gov.uk/admin/
ProxyPass /admin/pet-lichfield/ http://lichfield.petitions.mysociety.org/admin/
ProxyPass /admin/pet-barrow/ http://petitions.barrowbc.gov.uk/admin/
ProxyPass /admin/pet-westminster/ http://westminster.petitions.mysociety.org/admin/
ProxyPass /admin/pet-suffolkcoastal/ http://suffolkcoastal.petitions.mysociety.org/admin/
ProxyPass /admin/pet-waveney/ http://petitions.waveney.gov.uk/admin/
ProxyPass /admin/pet-hounslow/ http://hounslow.petitions.mysociety.org/admin/
ProxyPass /admin/pet-islington/ http://islington.petitions.mysociety.org/admin/
ProxyPass /admin/pet-newforest/ http://newforest.petitions.mysociety.org/admin/

ProxyPass /admin/sitestats/ http://sitestats.mysociety.org/admin/
ProxyPassReverse /admin/sitestats/ http://sitestats.mysociety.org/admin/
ProxyPass /admin/sitestats_media/ http://sitestats.mysociety.org/media/

ProxyPass /admin/gut/javascripts/ http://gut.mysociety.org/javascripts/
ProxyPass /admin/gut/ http://gut.mysociety.org/admin/

ProxyPass /admin/transport/ http://transport.mysociety.org/admin/
ProxyPass /admin/briefencounters/ http://briefencounters.mysociety.org/admin/
ProxyPass /admin/fixmytransport/ http://www.fixmytransport.com/admin/

# Run awstats.pl as CGI script
<Location /admin>
    Options +ExecCGI
    AddHandler cgi-script .pl
</Location>

# Rewrite links within the proxied site for stats
ProxyHTMLURLMap http://sitestats.mysociety.org/admin/ /admin/sitestats
<Location /admin/sitestats/>
  SetOutputFilter  proxy-html
  ProxyHTMLURLMap /admin/ /admin/sitestats/
  ProxyHTMLURLMap /media/ /admin/sitestats_media/  
</Location>

# Map awstats icons, readable by everyone
<Directory /usr/share/awstats/icon>
    Options None
    AllowOverride None
    Order allow,deny
    Allow from all
</Directory>
Alias /awstats-icon/ /usr/share/awstats/icon/

# Rewrite etc. for tracking CGI.
# Can't use a relative path here (apache feature).
<Directory /data/vhost/secure.mysociety.org/mysociety/track/web>
    Options +ExecCGI
    AddHandler fastcgi-script .cgi
</Directory>
Alias /track/ /data/vhost/secure.mysociety.org/mysociety/track/web/

RewriteRule ^/track$                /track/ [R]
RewriteRule ^/track/$               /track/track.cgi?ui=1 [PT]
RewriteRule ^/track/webbug\.png$    /track/track.cgi      [PT]

# PHP files can be referred without PHP
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}.php -f
RewriteRule /(.+) /$1.php [PT]

# HTML files can be referred without HTML
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}.html -f
RewriteRule /(.+) /$1.html [PT]
