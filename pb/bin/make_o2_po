#!/usr/bin/perl -w
use strict;

# Generates O2 version of .po file, which is a translation
# into a language the same as English, only "pledge" becomes "promise".

use POSIX;
use File::Copy;

# XXX: Running from /data/vhost/matthew.pb.com/mysociety/, this passes,
# as it changes to /data/mysociety/ here! Then the copy fails...
chdir("../../../mysociety/pb/bin") or die "Run from inside mysociety/pb/bin";
chdir("../../locale") or die "No locale directory";
mkdir("en_GB.UTF-8");
mkdir("en_GB.UTF-8/LC_MESSAGES");

File::Copy::syscopy("PledgeBank.po", "PledgeBankO2.po") or die "couldn't copy to PledgeBankO2.po: $!";
open(MAINPO, "PledgeBank.po") or die "";
open(NEWPO, ">en_GB.UTF-8/LC_MESSAGES/PledgeBankO2.po") or die "";

print NEWPO "# AUTOMATICALLY GENERATED by make_o2_po, do not edit\n";
print NEWPO "\n";

my $buffer = "";
my $start = 0;
while(<MAINPO>) {
    if (!$start) {
        s/#, fuzzy//;
    }
    if (m/"Last-Translator: FULL NAME/) {
        $_ = '"Last-Translator: mysociety/bin/make_o2_po\\n"'."\n";
    }
    if (m/"PO-Revision-Date: YEAR-MO-DA/) {
        my $time = POSIX::strftime("%Y-%m-%d %H:%M%z", localtime(time()));
        $_ = '"PO-Revision-Date: '.$time.'\\n"'."\n";
    }
    if (m/"Language-Team: LANGUAGE/) {
        $_ = '"Language-Team: O2 Promise Bank\\n"'."\n";
    }
    if (m/"Plural-Forms: nplurals=/) {
        $_ = '"Plural-Forms: nplurals=2; plural=n != 1;\\n"'."\n";
    }

    if (m/^#/) {
        # comment or blank line
        print NEWPO $_;
    } elsif (m/^\s+$/) {
        # blank line
        $start = 1;
        $buffer = "";
        print NEWPO $_;
    } elsif ($start && (m/^msgstr ""/ || m/^msgstr\[0\] ""/)) {
        # start of translated text - translate English into Live Simple Promise
        # langauage
        if (m/^msgstr\[0\] ""/) {
            $buffer =~ s/^msgid "/msgstr[0] "/m;
            $buffer =~ s/^msgid_plural "/msgstr[1] "/m;
            <MAINPO>; # skip untranslated plural
        } else {
            $buffer =~ s/^msgid "/msgstr "/;
        }

        $buffer =~ s/PledgeBank.com/O2 Promise Bank/g;
        $buffer =~ s/PledgeBank/O2 Promise Bank/g;
        $buffer =~ s/<font color=\\"#ffffff\\">Pledge<\/font>Bank.com/<font color=\\"#ffffff\\">O2 Promise Bank<\/font>/;
        $buffer =~ s/\bpledge\b/promise/g;
        $buffer =~ s/\bPledge\b/Promise/g;
        $buffer =~ s/\bpledges\b/promises/g;
        $buffer =~ s/\bPledges\b/Promises/g;
        $buffer =~ s/a O2 Promise Bank/an O2 Promise Bank/;

        # Front page
        $buffer =~ s/"O2 Promise Bank is free and easy.*"/"What can you do to make the People Promise come alive? Your promise can be for you or for your whole team. Once you've decided:"/s;
        $buffer =~ s/Start your own promise/Make your promise/g;
        $buffer =~ s/Why not sign a live promise\?/Sign up to a live promise/;

        # Pledge creation
        $buffer =~ s/The other people must sign up before/I will complete my pledge by/;
        $buffer =~ s/"On flyers.*"/"If your promise is on behalf of a team, please enter the team name here:"/s;
        $buffer =~ s/\(e.g. \\"resident of Tamilda Road\\"\)/(e.g. Customer Service Finance)/;
        $buffer =~ s#<Date>#dd/mm/yy#;
        $buffer =~ s/More details about your promise: \(optional\)/Tell us more about your Promise: (optional, 100 characters maximum)/;
        $buffer =~ s/Change your postal address/Change your location/;
        $buffer =~ s/tidyupthepark/Saythanks/;

        # Pledge display
        $buffer =~ s/Deadline to sign up by:/My Promise will be completed by:/;

        $buffer =~ s/<Enter town or keyword>/<Word or person>/;
#$buffer =~ s#-- the livesimply:promise team#The livesimply:promise team\\n"\n"http://promise.livesimply.org.uk#;
        print NEWPO $buffer;
        $buffer = "";
    } else {
        # English text
        print NEWPO $_;
        $buffer .= $_;
    }

}

