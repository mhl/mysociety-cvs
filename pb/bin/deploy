#!/bin/sh
#
# deploy:
# Update installation of PledgeBank from CVS.
#
# Copyright (c) 2005 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: deploy,v 1.7 2005-11-04 10:54:13 francis Exp $
#

set -e
#set -x # trace everything for debug

# Check who and where we are, and include useful functions
PB_BIN=`pwd`
MYSOCIETY_BIN=$PB_BIN/../../bin
SCRIPT_COMMAND=pb/bin/deploy
. ../../shlib/deployfns
check_who_where very.unfortu.net root

# User to load test schema
PSQL_SCHEMATEST_USER=pgsql

# Load in parameters
if [ "$1" = "www.pledgebank.com" ]
then
    PB_VHOST=/data/vhost/www.pledgebank.com
    PB_SMSD=pbsmsd
    PB_UNAME=pb
elif [ "$1" = "staging.pledgebank.com" ]
then
    PB_VHOST=/data/vhost/staging.pledgebank.com
    PB_SMSD=pbstagingsmsd
    PB_UNAME=pb
elif [ "$1" = "interface.pledgebank.com" ]
then
    PB_VHOST=/data/vhost/interface.pledgebank.com
    PB_SMSD=pbinterfacesmsd
    PB_UNAME=pbinterface
else 
    die "specify staging.pledgebank.com, www.pledgebank.com or interface.pledgebank.com as parameter"
fi

# Check virtual server directory
[ ! -d $PB_VHOST ] && die "virtual host directory $PB_VHOST not found"

# Pledge Bank
PB_NAME="PledgeBank.com"
PB_DEPLOYSPACE=$PB_VHOST/deployspace
hostname=$( echo $PB_VHOST | sed 's@/$@@' | sed 's@^.*/@@' )
PB_DB_UNIX_USER=$PB_UNAME

# Main body of script
fmt << END
This will update $PB_VHOST from CVS and gracefully restart 
Apache, and restart SMS daemon.  It will warn you first if any database
schemas need upgrading, or config files fixing.  These get fixed in the
deploy space, i.e. the place where the "cvs export" happens to, before
copying over to the live server.

Press RETURN to continue.
END
read DUMMY

warn "Exporting from CVS..."
cvs_export $PB_UNAME $PB_VHOST $PB_DEPLOYSPACE

warn "Checking config files..."
check_config_files $PB_DEPLOYSPACE/mysociety/pb/conf

warn "Checking database schemas..."
read_conf $PB_DEPLOYSPACE/mysociety/pb/conf/general
check_pgsql_schema $PB_DB_UNIX_USER $PB_DEPLOYSPACE/mysociety/pb/db/schema.sql $OPTION_PB_DB_NAME $OPTION_PB_DB_USER $OPTION_PB_DB_PASS 

warn "Stopping services..."
daemon_stop $PB_SMSD
down_notice $PB_VHOST $PB_NAME

warn "Rsyncing new data files..."
rsync_across $PB_DEPLOYSPACE $PB_VHOST
$PB_VHOST/mysociety/bin/localesymlinks

warn "Starting services..."
apachectl graceful
up_notice $PB_VHOST
daemon_start $PB_SMSD

