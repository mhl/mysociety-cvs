#!/usr/local/bin/php -q
<?php

/* daily:
 * To be run daily, just after midnight, to send out failure messages
 * (And probably things like "wow, look how many you over-subscribed" messages)
 *
 * Copyright (c) 2005 UK Citizens Online Democracy. All rights reserved.
 * Email: matthew@mysociety.org. WWW: http://www.mysociety.org/
 *
 * $Id: daily,v 1.2 2005-01-28 19:01:16 matthew Exp $
 *
 */

$short_opts = 'd';
$long_opts = array('debug');
require_once 'phpcgi';
$debug = isset($options[0][0][0]) ? 1 : 0;

$today = date('Y-m-d');

require_once "../conf/general";
include_once '../phplib/db.php';
include_once '../phplib/fns.php';
include_once '../../phplib/utility.php';

db_connect();

$q = db_query('SELECT id, title, target, type, date+1 AS date, name, email FROM pledges WHERE confirmed = 1');
while ($r = db_fetch_array($q)) {
    $signatures = db_getOne('SELECT COUNT(*) FROM signers WHERE pledge_id = ?', array($r['id']));

    # Out of time
    if ($r['date'] == $today) {
        if ($signatures < $r['target']) {
            # Failure
            if (!send_failure_email($r))
                print "Failure sending one or more failure messages to pledgees of pledge $r[id] ($r[title])\n";
            elseif ($debug)
                print "Failure messages sent for pledge $r[id] ($r[title])\n";
        } else {
            # Email pledge creator with success
            $subject = 'PledgeBank pledge completion - "' . $r['title'] . '"';
            $body = "Dear $r[name],\n\nWe are pleased to tell you that your pledge " . ($signatures>$r['target']?'exceeded':'met') . " its target in the required time.\n\nWoohoo!.";
            if (!pb_send_email($r['email'], $subject, $body))
                print "Failure sending success message to pledge creator, pledge $r[id] ($r[title])\n";
            elseif ($debug)
                print "Success message sent to pledge creator for pledge $r[id] ($r[title])\n";
        }
        continue;
    }
}

# ------------------------------------------

function send_failure_email($row) {
    $globalsuccess = 1;

    $pledge_id = $row['id'];
    $action = $row['title'];
    $target = $row['target'];
    $type = $row['type'];
    $name = $row['name'];
    $email = $row['email'];

    $q = db_query('SELECT signname, signemail FROM signers WHERE pledges.id=? AND signers.confirmed=1', array($pledge_id));
    $actual = db_num_rows($q);

    $subject = 'PledgeBank pledge failure - "' . $action . '"';
    $body = "Dear $name,\n\nWe are sorry to have to tell you that your pledge did not meet its target in the required time.\n\nYou required $target $type, but achieved only $actual.\n\nAh well, better luck next time.";
    $success = pb_send_email($email, $subject, $body);
    if ($success==0) $globalsuccess = 0;

    $body = "Dear NAME,\n\nWe are sorry to have to inform you that the pledge to which you signed up did not meet its target in the required time.\n\nIt required $target $type, but achieved only $actual.\n\nDon't be disheartened!";
    while ($r = db_fetch_array($q)) {
        $signname = $r['signname'];
	$signemail = $r['signemail'];
	$success = pb_send_email($signemail, $subject, str_replace('NAME', $signname, $body));
	if ($success==0) $globalsuccess = 0;
    }
    return $globalsuccess;
}
