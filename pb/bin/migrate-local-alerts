#!/usr/local/bin/php -q
<?php
/* 
 * migrate-local-alerts:
 * From old to new scheme
 *
 * Copyright (c) 2005 UK Citizens Online Democracy. All rights reserved.
 * Email: francis@mysociety.org. WWW: http://www.mysociety.org/
 *
 * $Id: migrate-local-alerts,v 1.1 2005-07-04 22:24:56 francis Exp $
 *
 */

require_once "../conf/general";
require_once '../phplib/db.php';
require_once '../phplib/fns.php';
require_once "../phplib/auth.php";
require_once "../phplib/person.php";
require_once "../phplib/alert.php";
require_once '../../phplib/utility.php';

function verbose($str) {
    global $verbose;
    if ($verbose) 
        fwrite(STDERR, "send-local-alerts: $str\n");
}
function error($str) {
    fwrite(STDERR, "send-local-alerts: ERROR: $str\n");
}

$short_opts = '';
$long_opts = array('verbose','help');
require_once 'phpcgi';

$switches = $options[0];
$args = $options[1];
$verbose = 0; 
foreach ($switches as $switch) {
    if ($switch[0]=='--verbose') $verbose = 1;
    if ($switch[0]=='--help') {
?>

PledgeBank local alert sending script.

Usage: send-local-alerts [--verbose]

--help      Display this help message
--verbose   Display more information

<?
        exit;
    }
}

// Main code at end.

// main code
db_connect();
verbose("migrating alerts");

// Grab all relevant alerts
$p = db_query("select * from local_alert where postcode not like '%@%'");

while ($row = db_fetch_array($p)) {
    // Search for pledges matching alert
    print "migrating person " . $row['person_id'] . " postcode " . $row['postcode'] . "\n";
    alert_signup($row['person_id'], "pledges/local/GB", array('postcode'=>$row['postcode']));
    db_query("delete from local_alert where person_id = ? and postcode = ?", 
            array($row['person_id'], $row['postcode']));
}
db_commit();

