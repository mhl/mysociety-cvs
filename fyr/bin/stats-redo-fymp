#!/usr/bin/perl -w

my $rcsid = ''; $rcsid .= '$Id: stats-redo-fymp,v 1.1 2006-02-19 12:40:31 matthew Exp $';

use strict;
require 5.8.0;

# Horrible boilerplate to set up appropriate library paths.
use FindBin;
use lib "$FindBin::Bin/../perllib";
use lib "$FindBin::Bin/../../perllib";

use utf8;
binmode(STDOUT, ':utf8');

use mySociety::Util;

open (FP, '../web/fymp.html');
$_ = join('', <FP>);
close FP;

print '<?php
/* Automatically generated by fyr/bin/stats-redo-fymp */

$questionnaire_report_FYMP_WMC = array(
';

my $c = 0;
while (/<tr>(.*?)<\/tr>/sg) {
    my $row = $1;
    my ($name, $cons, $party, $total, $yes, $no, $percent, $notes) = $row =~ /<td>(.*?)<\/td>/g;
    $name =~ s/'/\\'/g;
    $cons =~ s/'/\\'/g;
    $party =~ s/<\/?font.*?>//g;
    my $responded_outof = $yes+$no;
    my ($re_mean, $re_low, $re_high) = $responded_outof>0 ? mySociety::Util::binomial_confidence_interval($yes, $responded_outof) : ('', '', '');
    my $time = time();
    my $category = 'good';
    $category = 'toofew' if ($notes eq 'No data');
    $category = 'shame' if ($notes eq 'Does not accept messages');
    $category = 'badcontact' if ($notes eq 'No contact details');
    $c++;
    print "    array(
        'category' => '$category',
        'name' => '$name',
        'party' => '$party',
        'area' => '$cons',
        'dispatched_success' => '$total',
        'responded' => '$yes',
        'responded_outof' => '$responded_outof',
        'responded_mean' => '$re_mean',
        'responded_95_low' => '$re_low',
        'responded_95_high' => '$re_high',
        'when_generated' => '$time'
    ),\n";
}
print ");\n";
