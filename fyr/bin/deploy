#!/bin/sh
#
# deploy:
# Update installation of FYR (writetothem) from CVS.
#
# Copyright (c) 2004 UK Citizens Online Democracy. All rights reserved.
# Email: chris@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: deploy,v 1.6 2005-01-04 11:34:16 francis Exp $
#

set -e

# Check who and where we are, and include useful functions
FYR_BIN=`pwd`
MYSOCIETY_BIN=$FYR_BIN/../../bin
EXPECTED_HOST=very.unfortu.net
SCRIPT_COMMAND=fyr/bin/deploy
. ../../shlib/deployfns

# User to load test schema
PSQL_SCHEMATEST_USER=pgsql

# Which virtual server to update
FYR_VHOST=$1
[ x$FYR_VHOST = x ] && die "specify target vhost directory as single argument"
[ ! -d $FYR_VHOST ] && die "specify target vhost directory as single argument"

# Write To Them
FYR_NAME="WriteToThem.com"
FYR_UNAME=fyr
FYR_DEPLOYSPACE=$FYR_VHOST/deployspace
hostname=$( echo $FYR_VHOST | sed 's@/$@@' | sed 's@^.*/@@' )
FYR_QUEUE_DB_UNIX_USER=fyr

# Main body of script
fmt << END
This will update $hostname from CVS and gracefully restart 
Apache.  It will warn you first if any database schemas need
upgrading, or config files fixing.  These get fixed in the deploy
space, i.e. the place where the "cvs export" happens to, before
copying over to the live server.

You should ensure that fyrqd is not running when this script is run.

Press RETURN to continue.
END
read DUMMY

warn "Exporting from CVS..."
cvs_export $FYR_UNAME $FYR_VHOST $FYR_DEPLOYSPACE

warn "Checking config files..."
check_config_files $FYR_DEPLOYSPACE/mysociety/fyr/conf

warn "Checking database schemas..."
read_conf $FYR_DEPLOYSPACE/mysociety/fyr/conf/general
check_pgsql_schema $FYR_QUEUE_DB_UNIX_USER $FYR_DEPLOYSPACE/mysociety/fyr/db/schema.sql $OPTION_FYR_QUEUE_DB_NAME $OPTION_FYR_QUEUE_DB_USER $OPTION_FYR_QUEUE_DB_PASS 

warn "Stopping services..."
down_notice $FYR_VHOST $FYR_NAME

warn "Rsyncing new data files..."
rsync_across $FYR_DEPLOYSPACE $FYR_VHOST

warn "Starting services..."
apachectl graceful
up_notice $FYR_VHOST
