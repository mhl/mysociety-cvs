#!/usr/bin/perl -w -I../../perllib
#
# test-run:
# Test harness for WriteToThem.  Makes sure we haven't broken the code.
# 
# Requires:
# * ../general/conf file set up for WriteToThem, and matching the below requirements
# * apache configured to serve ../web on OPTION_BASE_URL
# * an FYR database with name ending "_testharness"; this script will drop and remake 
#   the database, so make sure it is never used for anything important
# * email addresses (email_n below) configured to pipe to ./test-mailin with fast
#   local delivery
# * a Ratty database with name ending "_testharness", also configured in ../general/conf
#   (an entry not normally present when running FYR) and in the ratty service
#   that OPTION_RATTY_URL talks to.
#
# Copyright (c) 2005 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#

# TODO:
# Trap ratty rule
# Sending faxes
# Questionaire
# Admin pages

my $rcsid = ''; $rcsid .= '$Id: test-run,v 1.7 2005-07-19 09:44:26 francis Exp $';

use strict;
require 5.8.0;

use Data::Dumper;
use Carp qw(verbose);
use Storable;
use FindBin;
use Getopt::Long;

use mySociety::Config;
mySociety::Config::set_file('../conf/general');
use mySociety::DBHandle qw(dbh);
use mySociety::WebTestHarness;

sub help {
print <<END

Usage: test-run [OPTION}

Options are
    --verbose=n   Choose 0 (no progress), 1 (basic actions), 2 (full debug)

END
}

# Parse command line
our $verbose = 0; # currently 3 levels: 0, 1 and 2
our $help;
if (!GetOptions(
        'verbose=i' =>  \$verbose,
        'help' =>               \$help
    )) {
    help();
    exit(1);
}
if ($help) {
    help();
    exit(0);
}

# Set up options

our $base_url = mySociety::Config::get('BASE_URL');
our $admin_url = mySociety::Config::get('ADMIN_URL');
our $httpd_error_log = mySociety::Config::get('HTTPD_ERROR_LOG');
sub email_n { my $n = shift; return "fyrharness+$n\@writetothem.owl"; }
sub name_n { my $n = shift; return "Cate Constituent $n"; }

#############################################################################
# Main code

# Configure test harness class
print "Set up web test harness...\n" if $verbose > 0;
our $wth = new mySociety::WebTestHarness();
$wth->log_watcher_setup($httpd_error_log);
$wth->database_connect('RATTY_');
$wth->database_drop_reload('../../services/Ratty/schema.sql');
$wth->database_cycle_sequences(200);
$wth->database_connect('FYR_QUEUE_');
$wth->database_drop_reload('../db/schema.sql');
$wth->database_cycle_sequences(200);
$wth->email_setup({ eveld_bin => undef, # "$FindBin::Bin/../../services/EvEl/bin/eveld",
                    log_mailbox => "log_mailbox" });

# Syntax check all .php files
print "Syntax check all PHP files...\n" if $verbose > 0;
$wth->php_check_syntax("../../fyr/");
$wth->php_check_syntax("../../fyr/templates/emails/", qr//);

# Check that we can detect PHP errors
print "Confirm we can detect errors...\n" if $verbose > 0;
$wth->log_watcher_check();
$wth->browser_get($base_url . "/test.php?error=1" );
my $errors = $wth->log_watcher_get_errors();
die "Unable to detect errors from PHP" if ($errors !~ m/deliberate_error_to_test_error_handling/);

print "Sending example message...\n" if $verbose > 0;
do_send_example_message();
print "Testing ratty blocking message...\n" if $verbose > 0;
do_send_blocked_message();

# Check for any unhandled mails or errors
print "Checking no emails left at end...\n" if $verbose > 1;
$wth->email_check_none_left();
print "Checking no log file errors at end...\n" if $verbose > 1;
$wth->log_watcher_check();
print "Everything completed successfully\n";

#############################################################################
# General functions

# Call fyrqd for one pass
sub call_fyrqd {
    system("./fyrqd", "--debug", "--once", "--email", # $verbose > 1 ? qw(--verbose) : ()
        ) and die "Failed to call fyrqd";
}

sub send_message {
    my ($who, $postcode, $repname, $fields) = @_;
    $fields->{writer_name} = name_n($who);
    $fields->{writer_email} = email_n($who);
    
    $wth->browser_get($base_url);
    $wth->browser_check_contents("First, type your UK postcode:");
    $wth->browser_check_contents("This is a test version"); # Make sure mail will loop back rather than go to rep

    # Choose
    $wth->browser_submit_form(form_name => 'postcodeForm',
        fields => { pc => $postcode},  
        );
    $wth->browser_check_contents("Now select the representative you'd like to contact");
    $wth->browser_follow_link(text_regex => qr/$repname/);
    $wth->browser_check_contents("Now Write Your Message");

    # Fill in a test letter
    $wth->browser_submit_form(form_name => 'writeForm',
        fields => $fields, button => 'submitPreview');
    # ... check preview and submit it
    $wth->browser_check_contents('Now Preview The Message');
    $wth->browser_check_contents($fields->{body});
    $wth->browser_submit_form(form_name => 'previewForm', button => 'submitSendFax');
    $wth->browser_check_contents('Nearly Done! Now check your email');

    # Wait for confirmation email to arrive
    call_fyrqd();
    # Click link in the confirmation email
    my $confirmation_email = $wth->email_get_containing(
        '%To: '.name_n($who).' <'.email_n($who).'>'.
        '%Subject: Please confirm that you want to send a message to '.$repname.' MP'.
        '%THIS IS A TEST SITE, THE MESSAGE WILL BE SENT TO YOURSELF'.
        '%to confirm that you wish%');
    die "Message confirmation link not found" if ($confirmation_email !~ m#^\s*($base_url.*$)#m);
    print "Message confirm URL is $1\n" if $verbose > 1;
    $wth->email_check_url($1);
    $wth->browser_get($1);
    $wth->browser_check_contents("All done... We'll send your message now");
    # TODO: Check message isn't sent early

    # Check message is delivered to the representative
    call_fyrqd();
    my $confirmation_email = $wth->email_get_containing(
        '%From: '.name_n($who).' <'.email_n($who).'>'.
        '%To: '.$repname.' MP <'.email_n($who).'>'.
        '%Subject: Letter from your constituent '.name_n($who).
        '%'.$fields->{writer_address1}.
        '%Signed with an electronic signature%');
}

#############################################################################

sub do_send_example_message() {
    send_message(0, 
        'CB23QJ', # The Guildhall, Cambridege 
        'David Howarth', 
        { 
            writer_address1 => '23 Something Street',
            writer_town => 'Someplace',
            writer_county => 'Someshire',
            writer_phone => undef,
            body => "This is a test message which shouldn't ever get to a real representative. It means the test harness is working."
        } 
    );
}

#############################################################################

sub do_send_blocked_message() {
    # Go to abuse rules page
    $wth->browser_get($admin_url);    
    $wth->browser_follow_link(text_regex => qr/Message Abuse Rules/);
    # ... check no existing rules
    $wth->browser_check_no_contents('View');

    # ... make new rule
    $wth->browser_follow_link(text_regex => qr/New rule/);
    $wth->browser_submit_form(form_name => 'adminRattyRuleForm',
        fields => {}, button => 'newfilter');
    $wth->browser_submit_form(form_name => 'adminRattyRuleForm', 
        fields => { 
            note => 'Block quicker than you can imagine',
            sequence => 1,
            requests => 0, interval => 0,
            message => 'freeze',
            field1 => 'message_length_characters',
            condition1 => '+<',
            value1 => '10',
        }, 
        button => 'done');
    $wth->browser_check_contents('Block quicker than you can imagine');

    send_message(1, 
        'CB23QJ', # The Guildhall, Cambridege 
        'David Howarth', 
        { 
            writer_address1 => '23 Something Street',
            writer_town => 'Someplace',
            writer_county => 'Someshire',
            writer_phone => undef,
            body => "V. short"
        } 
    );
}


