#!/usr/bin/perl -w -I../../perllib -I../../../perllib
#
# server:
#
# Copyright (c) 2004 UK Citizens Online Democracy. All rights reserved.
# Email: chris@mysociety.org; WWW: http://www.mysociety.org/
#

my $rcsid = ''; $rcsid .= '$Id: queue,v 1.2 2004-11-10 09:50:39 francis Exp $';

use FCGI;
use FYR;
use FYR::Queue;
use mySociety::DaDem;
use mySociety::Config;
use RABX;
use XMLRPC::Transport::HTTP;

mySociety::Config::set_file('../../conf/general');
mySociety::DaDem::configure(mySociety::Config::get('OPTION_DADEM_URL'));

use mySociety::WatchUpdate;
my $W = new mySociety::WatchUpdate();

my $req = FCGI::Request();

while ($req->Accept() >= 0) {
    if ($ENV{REQUEST_METHOD} eq 'POST' and $ENV{CONTENT_TYPE} eq 'text/xml') {
        my $s = XMLRPC::Transport::HTTP::CGI->dispatch_to('FYR::Queue')->handle();
    } else {
        RABX::Server::CGI::dispatch(
                'FYR.Queue.create' => sub {
                    return FYR::Queue->create(@_);
                },
                'FYR.Queue.write' => sub {
                    return FYR::Queue->write(@_);
                },
                'FYR.Queue.secret' => sub {
                    return FYR::Queue->secret(@_);
                },
                'FYR.Queue.confirm_email' => sub {
                    return FYR::Queue->confirm_email(@_);
                }
            );
    }
    $W->exit_if_changed();
}




