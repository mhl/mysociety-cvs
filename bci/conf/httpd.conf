# Apache configuration for Broken Civic Infrastructure.
#
# Add lines something like this to your main /etc/apache/httpd.conf:
#
# # BCI
# <VirtualHost *:80>
#     ServerName bci.owl
#     DocumentRoot /home/francis/devel/mysociety/bci/web/
#     <Directory /home/francis/devel/mysociety/bci/web>
#         Include /home/francis/devel/mysociety/bci/conf/httpd.conf
#     </Directory>
#     Alias /admin/ /home/francis/devel/mysociety/bci/web-admin/
# </VirtualHost>
#
# You also need to enable cgi files to run as CGI scripts.  For example:
#
#  Options +ExecCGI
#  AddHandler cgi-script .cgi
# 
# Copyright (c) 2006 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org
# 
# $Id: httpd.conf,v 1.26 2007-09-18 11:17:24 matthew Exp $

DirectoryIndex index.cgi

RewriteEngine on
#RewriteLog /var/log/apache/rewrite.log
#RewriteLogLevel 3

# End slashes goodbye
RewriteRule ^/admin/     - [L]
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-d
RewriteRule ^(.+)/$     $1 [R=permanent]

# Confirmation tokens
RewriteRule ^/[Aa]/([0-9A-Za-z]{16}).*$ /alert.cgi?token=$1
RewriteRule ^/[Cc]/([0-9A-Za-z]{16}).*$ /confirm.cgi?type=update;token=$1
RewriteRule ^/[Pp]/([0-9A-Za-z]{16}).*$ /confirm.cgi?type=problem;token=$1
RewriteRule ^/[Qq]/([0-9A-Za-z]{16}).*$ /questionnaire.cgi?token=$1
RewriteRule ^/[Ff]/([0-9A-Za-z]{16}).*$ /flickr.cgi?token=$1
RewriteRule ^/[Ll]/([0-9A-Za-z]{16}).*$ /flickr2.cgi?token=$1

# RSS feeds for updates on a problem
RewriteRule ^/rss/([0-9]+)$              /rss.cgi?type=new_updates;id=$1 [QSA]

# RSS feeds for new local problems
RewriteRule ^/rss/([0-9]+)[,/]([0-9]+)$              /rss.cgi?type=local_problems;x=$1;y=$2 [QSA]
RewriteRule ^/rss/l/([0-9.-]+)[,/]([0-9.-]+)$        /rss.cgi?type=local_problems;lat=$1;lon=$2 [QSA]
RewriteRule ^/rss/([0-9]+)[,/]([0-9]+)/([0-9]+)$     /rss.cgi?type=local_problems;x=$1;y=$2;d=$3 [QSA]
RewriteRule ^/rss/l/([0-9]+)[,/]([0-9]+)/([0-9]+)$   /rss.cgi?type=local_problems;lat=$1;lon=$2;d=$3 [QSA]
RewriteRule ^/rss/problems$                          /rss.cgi?type=new_problems [QSA]

# RSS feeds for voting areas
RewriteRule ^/rss/council/([0-9]+)$                 /rss/reports/$1 [R=permanent]
RewriteRule ^/report$                               /reports   [R=permanent]
RewriteRule ^/reports/([^/]+)/all$                  /reports.cgi?council=$1;all=1  [QSA]
RewriteRule ^/reports/([^/]+)/([^/]+)$              /reports.cgi?council=$1;ward=$2  [QSA]
RewriteRule ^/rss/(reports|area)/([^/]+)/([^/]+)$   /reports.cgi?rss=$1;council=$2;ward=$3 [QSA]
RewriteRule ^/reports/([^/]+)$                      /reports.cgi?council=$1  [QSA]
RewriteRule ^/rss/area/([0-9]+)$                    /rss.cgi?type=area_problems;id=$1 [QSA]
RewriteRule ^/rss/(reports|area)/([^/]+)$           /reports.cgi?rss=$1;council=$2 [QSA]

RewriteRule ^/report/([0-9]+)$               /index.cgi?id=$1 [QSA]

ProxyPass /tilma/ http://tilma.mysociety.org/
ProxyPassReverse /tilma/ http://tilma.mysociety.org/

# CGI files can be referred without CGI
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}.cgi -f
RewriteRule /(.+) /$1.cgi [PT]

# Make a file down.html in the DocumentRoot bring down the whole site and
# display itself.
RewriteCond %{DOCUMENT_ROOT}/down.html -s
RewriteRule /(.+).cgi /down.html [R]
RewriteCond %{DOCUMENT_ROOT}/down.html !-s
RewriteRule /down.html / [R]

