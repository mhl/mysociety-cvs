#!/usr/bin/perl -w

# send-reports:
# Send new problem reports to councils
#
# Copyright (c) 2007 UK Citizens Online Democracy. All rights reserved.
# Email: matthew@mysociety.org. WWW: http://www.mysociety.org
#
# $Id: send-reports,v 1.44 2007-07-11 16:39:02 matthew Exp $

use strict;
require 5.8.0;

# Horrible boilerplate to set up appropriate library paths.
use FindBin;
use lib "$FindBin::Bin/../perllib";
use lib "$FindBin::Bin/../../perllib";
use File::Slurp;

use mySociety::Config;
use mySociety::DBHandle qw(dbh select_all);
use mySociety::Email;
use mySociety::MaPit;
use mySociety::Util;

BEGIN {
    mySociety::Config::set_file("$FindBin::Bin/../conf/general");
    mySociety::DBHandle::configure(
        Name => mySociety::Config::get('BCI_DB_NAME'),
        User => mySociety::Config::get('BCI_DB_USER'),
        Password => mySociety::Config::get('BCI_DB_PASS'),
        Host => mySociety::Config::get('BCI_DB_HOST', undef),
        Port => mySociety::Config::get('BCI_DB_PORT', undef)
    );
}

use mySociety::Dress;

die "Either no arguments, --nomail or --verbose" if (@ARGV>1);
my $nomail = 0;
my $verbose = 0;
$nomail = 1 if (@ARGV==1 && $ARGV[0] eq '--nomail');
$verbose = 1 if (@ARGV==1 && $ARGV[0] eq '--verbose');
$verbose = 1 if $nomail;

my (%notgot, %note);
my $unsent = dbh()->selectall_arrayref(
    "SELECT id, council, category, title, detail, name, email, phone, used_map,
    easting, northing, (photo is not null) as has_photo
    FROM problem WHERE state in ('confirmed','fixed') AND whensent IS NULL
    AND council IS NOT NULL", { Slice => {} });

foreach my $row (@$unsent) {

    if (dbh()->selectrow_array('select email from abuse where lower(email)=?', {}, lc($row->{email}))) {
        dbh()->do("update problem set state='hidden' where id=?", {}, $row->{id});
	dbh()->commit();
        next;
    }
    # XXX Needs locks!
    my @all_councils = split /,|\|/, $row->{council};
    my ($councils, $missing) = $row->{council} =~ /^([\d,]+)(?:\|([\d,]+))?/;
    my @councils = split /,/, $councils;
    my $areas_info = mySociety::MaPit::get_voting_areas_info(\@all_councils);
    my (@to, @dear, %recips);
    my $all_confirmed = 1;
    foreach my $council (@councils) {
        my $name = $areas_info->{$council}->{name};
        my ($council_email, $confirmed, $note) = dbh()->selectrow_array(
            "SELECT email,confirmed,note FROM contacts WHERE deleted='f'
                and area_id=? AND category=?", {}, $council, $row->{category});
        $council_email = essex_contact($row->{easting}, $row->{northing}) if $council == 2225;
        $council_email = notts_contact($row->{easting}, $row->{northing}) if $council == 2236;
        unless ($confirmed) {
            $all_confirmed = 0;
            $note = 'Council ' . $row->{council} . ' deleted'
                unless $note;
            $council_email = 'N/A' unless $council_email;
            $notgot{$council_email}{$row->{category}}++;
            $note{$council_email}{$row->{category}} = $note;
        }
        push @to, [ $council_email, $name ];
        push @dear, $name;
        $recips{$council_email} = 1;
    }
    my @recips = keys %recips;
    if (!@to) {
        if ($verbose) {
            print 'Need to send problem #' . $row->{id} . ' to council(s) ' . join(',',@recips) . "\n";
            print "  ...but we have no contact details for any of them!\n";
        }
        next;
    }
    next unless ($all_confirmed);

    push @recips, mySociety::Config::get('CONTACT_EMAIL');

    my $template = File::Slurp::read_file("$FindBin::Bin/../templates/emails/submit-council");
    my %h = map { $_ => $row->{$_} } qw/title detail name email phone category/;
    $h{phone} = "Phone: $h{phone}\n\n" if $h{phone};
    $h{has_photo} = '';
    $h{has_photo} = "This web page also contains a photo of the problem, provided by the user.\n\n" if $row->{has_photo};
    if ($h{category} eq 'Other') {
        $h{category_footer} = 'this type of local problem';
        $h{category} = '';
    } else {
        $h{category_footer} = "'" . $h{category} . "'";
        $h{category} = "Category: $h{category}\n\n";
    }
    $h{url} = mySociety::Config::get('BASE_URL') . '/?id=' . $row->{id};
    $h{councils_name} = join(' and ', @dear);
    $h{fuzzy} = $row->{used_map} ? 'To view a map of the precise location of this issue'
        : 'The user could not locate the problem on a map, but to see the area around the location they entered';
    $h{multiple} = @dear>1 ? "[ This email has been sent to both councils covering the location of the problem, as the user did not categorise it; please ignore it if you're not the correct council to deal with the issue, or let us know what category of problem this is so we can add it to our system. ]\n\n"
        : '';
    $h{missing} = ''; 
    if ($missing) {
        my $name = $areas_info->{$missing}->{name};
        $h{missing} = '[ We realise this problem might be the responsibility of ' . $name
            . "; however, we don't currently have any contact details for them.
If you know of an appropriate contact address, please do get in touch. ]\n\n";
    }

    $h{closest_address} = '';
    my ($address, $distance) = mySociety::Dress::find_nearest($row->{easting}, $row->{northing});
    $h{closest_address} = sprintf("The closest address to the location of this problem, %.0fm away, is: %s\n\n",
        $distance, $address) if ($address);
    my $email = mySociety::Email::construct_email({
        _template_ => $template,
        _parameters_ => \%h,
        To => \@to,
        From => [ $row->{email}, $row->{name} ]
    });

    my $result;
    if (mySociety::Config::get('STAGING_SITE') || $nomail) {
        $result = -1;
    } else {
        $result = mySociety::Util::send_email($email, mySociety::Config::get('CONTACT_EMAIL'), @recips);
    }
    if ($result == mySociety::Util::EMAIL_SUCCESS) {
        dbh()->do('UPDATE problem SET whensent=ms_current_timestamp(),
            lastupdate=ms_current_timestamp() WHERE id=?', {}, $row->{id});
        dbh()->commit();
    } else {
        dbh()->rollback();
    }
}

if ($verbose) {
    print "Council email addresses that need checking:\n" if keys %notgot;
    foreach my $e (keys %notgot) {
        foreach my $c (keys %{$notgot{$e}}) {
            print $notgot{$e}{$c} . " problem, to $e category $c (" . $note{$e}{$c}. ")\n";
        }
    }
}

# Essex has different contact addresses depending upon the district
# Might be easier if we start storing in the db all areas covered by a point
# Will do for now :)
sub essex_contact {
    my ($E, $N) = @_;
    my $district = mySociety::MaPit::get_voting_area_by_location_en($E, $N, 'polygon', 'DIS');
    $district = $district->[0];
    my $email;
    $email = 'eastarea' if $district == 2315 || $district == 2312;
    $email = 'midarea' if $district == 2317 || $district == 2314 || $district == 2316;
    $email = 'southarea' if $district == 2319 || $district == 2320 || $district == 2310;
    $email = 'westarea' if $district == 2309 || $district == 2311 || $district == 2318 || $district == 2313;
    die "Returned district $district which is not in Essex!" unless $email;
    return "highways.$email\@essexcc.gov.uk";
}

# Notts has different contact addresses depending upon the district
sub notts_contact {
    my ($E, $N) = @_;
    my $district = mySociety::MaPit::get_voting_area_by_location_en($E, $N, 'polygon', 'DIS');
    $district = $district->[0];
    my $email;
    $email = 'cshighsouth.en' if $district == 2411 || $district == 2412 || $district == 2415;
    $email = 'etwall' if $district == 2413 || $district == 2416;
    $email = 'bassetlawao' if $district == 2410;
    $email = 'newarkao' if $district == 2414;
    die "Returned district $district which is not in Nottinghamshire!" unless $email;
    return "$email\@nottscc.gov.uk";
}
