#!/bin/bash
#
# do-eurotrain:
#
# Copyright (c) 2008 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#

# TODO:
# Work out how to change mindist to use correct great circle distances
# Change maxwalkdist and speeds to be in km again
# Check out TIME_INFINITY

# Use this, more trustworthy:  tilestuff.pl in /home/matthew/euro/

#(16:31:10) Matthew Somerville: yo
#(16:31:39) Matthew Somerville: ok, so if you have lat of LAT and lon of LON
#(16:31:44) Matthew Somerville: and this map: http://bitter.ukcod.org.uk/~matthew/euro/test.html
#(16:31:58) Matthew Somerville: then the X and Y of the coordinates from the top-left are:
#(16:32:19) Matthew Somerville: X = (LON+11.25)/(45+11.25)*1280
#(16:33:00) Matthew Somerville: Y = (log(tan(LAT*pi/180)+sec(LAT*pi/180))/pi - MINY)/(MAXY-MINY)*1280
#(16:33:14) Matthew Somerville: where MINY = 0.187499652486244 and MAXY = 0.499999073296651
#(16:33:17) Matthew Somerville: dada!
#(16:35:50) Matthew Somerville: whoops, that gives you Y from bottom, do 1280-Y to get from top
#(16:36:13) Matthew Somerville: or a 1- in the middle somewhere
#(16:36:20) Matthew Somerville: maybe
#(16:36:43) Matthew Somerville: anyway, that does appear to work, let me just check on berlin
#(16:39:47) Matthew Somerville: http://bitter.ukcod.org.uk/~matthew/euro/test.html

# Parameters:
SIZE_M=250000 # length in metres of sides of rectangle round postcode
SIZE_PX=500
DIR=$HOME/toobig/isodata/eurotrainmaps/
WALKSPEED=25 # 4 m/s == 8.9 mph, 25 m/s = 55 mph
MAXWALKTIME=900 # 900 seconds default in old system
#BANDSIZE=6000; BANDCOUNT=200; BANDCOLSEP=1
BANDSIZE=7200; BANDCOUNT=25; BANDCOLSEP=10 # 2 hour bands

set -x # print each line
set -e # exit on error

# W E S N
#RECT="-9 39 35 66.3" # 35 -9 = sw of spain
RECT="0 $SIZE_PX 0 $SIZE_PX" # in pixel coordinates for this
#RESULTS=quicktest-1000-random-stations # input has east/north/time-in-secs
INPUT=stations-lat-lon-dur
RESULTS=$INPUT-px$SIZE_PX-bandsize$BANDSIZE-bandcount$BANDCOUNT # input has east/north/time-in-secs

# walkspeed = 1 m/s maxwalktime = 900 sec
cat $DIR/$INPUT | ./eurotrain-journeys-to-grid grid $SIZE_PX $SIZE_PX $WALKSPEED $MAXWALKTIME > $DIR/$RESULTS-grid
cat $DIR/$RESULTS-grid | ./grid-to-ppm field $RECT $SIZE_PX $SIZE_PX $BANDSIZE $BANDCOUNT $BANDCOLSEP > $DIR/$RESULTS.ppm
#cat $DIR/$RESULTS-grid | ./xxx field $RECT $SIZE_PX $SIZE_PX > $DIR/$RESULTS.ppm

convert $DIR/$RESULTS.ppm $DIR/$RESULTS.png
eog $DIR/$RESULTS.png



