#!/bin/bash
#
# do-eurotrain:
#
# Copyright (c) 2008 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#

# TODO:
# Work out how to change mindist to use correct great circle distances
# Change maxwalkdist and speeds to be in km again
# Check out TIME_INFINITY

# Test with Berlin:
# cat /home/francis/toobig/isodata/eurotrainmaps//stations-lat-lon-dur |  ./eurotrain-journeys-to-grid query 1280 1280 15 1800 561 638 2>&1 |less

# Parameters:
SIZE_M=250000 # length in metres of sides of rectangle round postcode
SIZE_PX=1280
DIR=$HOME/toobig/isodata/eurotrainmaps/

#WALKSPEED=25 # 4 m/s == 8.9 mph, 25 m/s = 55 mph
#MAXWALKTIME=900 # 900 seconds default in old system
#BANDSIZE=7200; BANDCOUNT=25; BANDCOLSEP=10 # 2 hour bands

WALKSPEED=15 # 4 m/s == 8.9 mph, 25 m/s = 55 mph # tom thinks use 15 m/s
MAXWALKTIME=1800 # 900 seconds  = 15 minutes default in old system
BANDSIZE=720; BANDCOUNT=200; BANDCOLSEP=1

set -x # print each line
set -e # exit on error

# W E S N
#RECT="-9 39 35 66.3" # 35 -9 = sw of spain
RECT="0 $SIZE_PX 0 $SIZE_PX" # in pixel coordinates for this
#RESULTS=quicktest-1000-random-stations # input has east/north/time-in-secs
INPUT=stations-lat-lon-dur
RESULTS=$INPUT-px$SIZE_PX-bandsize$BANDSIZE-bandcount$BANDCOUNT-walksp$WALKSPEED # input has east/north/time-in-secs

# walkspeed = 1 m/s maxwalktime = 900 sec
cat $DIR/$INPUT | ./eurotrain-journeys-to-grid grid $SIZE_PX $SIZE_PX $WALKSPEED $MAXWALKTIME > $DIR/$RESULTS-grid
cat $DIR/$RESULTS-grid | ./grid-to-ppm field $RECT $SIZE_PX $SIZE_PX $BANDSIZE $BANDCOUNT $BANDCOLSEP > $DIR/$RESULTS.ppm
#cat $DIR/$RESULTS-grid | ./xxx field $RECT $SIZE_PX $SIZE_PX > $DIR/$RESULTS.ppm

convert $DIR/$RESULTS.ppm $DIR/$RESULTS.png
eog $DIR/$RESULTS.png



