#!/bin/bash
#
# do-eurotrain:
#
# Copyright (c) 2008 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#

# Bigger grid squares, or accept solitary things are OK
# - recalibrate threshold using Les Essarts
# Change scraper to grab lots in each cell and only use first n
# Change scraper to not use duration
# Change date to far future

# Flatten accents out e.g. for Lodz, Rīga before feeding into bahn.de (maybe only in Poland?)
# Substring of all responses breaks on this one (Alhama is alternate name):
# +2521994        PPL     Alhama de Almería       3374            36.95   -2.5666667      82620   Alhama de Aragon
# +2523460        PPL     San Giovanni la Punta   20850   en.wikipedia.org/wiki/San_Giovanni_la_Punta     37.576054       15.098088       75720   San Giovanni di Casarsa
# baranavichy in Spain missing, as too lonely on grid cell
# Also probably error at 684 minutes - NW of Zagreb.
# Strip geonames aliases of extra whitespace

# Old TODO (check these were done OK):
# Work out how to change mindist to use correct great circle distances
# Change maxwalkdist and speeds to be in km again
# Check out TIME_INFINITY

# Test with Berlin:
# cat /home/francis/toobig/isodata/eurotrainmaps//stations-lat-lon-dur |  ./eurotrain-journeys-to-grid query 1280 1280 15 1800 561 638 2>&1 |less

# Parameters:
SIZE_PX=500 # 10240 # 1280
DIR=$HOME/toobig/isodata/neweurotrainmaps/

WALKSPEED=5 # 15 # 4 m/s == 8.9 mph, 25 m/s = 55 mph # tom thinks use 15 m/s
MAXWALKTIME=1800 # 900 seconds  = 15 minutes default in old system
BANDSIZE=1200; BANDCOUNT=200; BANDCOLSEP=1 # use 720 for simple; use 1080 band size for Bulgaria

set -x # print each line
set -e # exit on error

# W E S N
#RECT="-9 39 35 66.3" # 35 -9 = sw of spain
RECT="0 $SIZE_PX 0 $SIZE_PX" # in pixel coordinates for this
#RESULTS=quicktest-1000-random-stations # input has east/north/time-in-secs
#INPUT=around-cambridge-lat-lon-dur
INPUT=all-europe-cell1-13-lat-lon-dur
#INPUT=stations-lat-lon-dur
RESULTS=$INPUT-px$SIZE_PX-bandsize$BANDSIZE-bandcount$BANDCOUNT-walksp$WALKSPEED # input has east/north/time-in-secs

# walkspeed = 1 m/s maxwalktime = 900 sec
cat $DIR/$INPUT | ./eurotrain-journeys-to-grid grid $SIZE_PX $SIZE_PX $WALKSPEED $MAXWALKTIME > $DIR/$RESULTS-grid
cat $DIR/$RESULTS-grid | ./grid-to-ppm field $RECT $SIZE_PX $SIZE_PX $BANDSIZE $BANDCOUNT $BANDCOLSEP > $DIR/$RESULTS.ppm
#cat $DIR/$RESULTS-grid | ./xxx field $RECT $SIZE_PX $SIZE_PX > $DIR/$RESULTS.ppm

convert $DIR/$RESULTS.ppm $DIR/$RESULTS.png
eog $DIR/$RESULTS.png



