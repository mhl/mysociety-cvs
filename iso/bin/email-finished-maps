#!/usr/bin/python
#
# email-finished-maps:
# Send out emails to people who signed up rather than waited
# XXX Currently just prints out a template
#
# Copyright (c) 2009 UK Citizens Online Democracy. All rights reserved.
# Email: matthew@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: email-finished-maps,v 1.1 2009-04-28 13:24:52 matthew Exp $
#

import sys
sys.path.extend((sys.path[0]+"/../pylib", sys.path[0]+"/../../pylib", "/home/matthew/lib/python"))

import mysociety.config
mysociety.config.set_file(sys.path[0]+"/../conf/general")

from page import template

import coldb
db = coldb.get_cursor()

db.execute('''SELECT * FROM email_queue, map, station WHERE map.id=map_id AND target_station_id=station.id AND state='complete' ''')
for row in db:
    url = mysociety.config.get('BASE_URL') + 'station/' + row['text_id']
    server, port = row['working_server'].split(':')
    print template('email-map-ready', {
        'url': url,
        'long_description': row['long_description'],
        'server': server,
        'took': row['working_took'],
    }, 'txt')

