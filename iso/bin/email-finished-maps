#!/usr/bin/python
#
# email-finished-maps:
# Send out emails to people who signed up rather than waited
#
# Copyright (c) 2009 UK Citizens Online Democracy. All rights reserved.
# Email: matthew@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: email-finished-maps,v 1.4 2009-05-13 17:59:01 matthew Exp $
#

import sys
sys.path.extend((sys.path[0]+"/../pylib", sys.path[0]+"/../../pylib"))

import mysociety.config
mysociety.config.set_file(sys.path[0]+"/../conf/general")

from page import send_template_email

import coldb
db = coldb.get_cursor()

db.execute('''SELECT *, email_queue.id as queue_id FROM email_queue, map
    WHERE map.id=map_id AND state='complete' AND sent = 'f' ''')
queue = db.fetchall()
for row in queue:
    url = mysociety.config.get('BASE_URL') + 'postcode/' + row['target_postcode']
    server, port = row['working_server'].split(':')
    db.execute("UPDATE email_queue SET sent='t' where id=%s", (row['queue_id'],))
    db.execute('COMMIT')
    send_template_email(row['email'], 'email-map-ready.txt', {
        'url': url,
        'server': server,
        'took': row['working_took'],
    })

