#!/bin/bash
#
# do-tfl:
# Generate diagram of time travel to arrive at work by 9am by public transport
# to given postcode (in London).
#
# Run postcodes-into-db, stops-into-db first.
#
# Copyright (c) 2007 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#

# Parameters:
#POSTCODE=SE100AX
#POSTCODE=W127RJ
POSTCODE=E152NQ
SIZE_M=40000 # length in metres of sides of rectangle round postcode
SIZE_PX=1600
DIR=$HOME/toobig/isodata/tfl
DATE=11122007 # XXX you may want to wipe the journey's table in the db if you change this

#set -x # print each line
set -e # exit on error

RECT="`./calc-bounding-rectangle $DIR/postcodes.sqlite $POSTCODE $SIZE_M`"
RESULTS=tfliso-$POSTCODE-$SIZE_M

./tfl-scrape --db=$DIR/postcodes.sqlite --html=$DIR/html --to=$POSTCODE --size=$SIZE_M --date=$DATE > $DIR/$RESULTS

# walkspeed = 1 m/s maxwalktime = 900 sec
cat $DIR/$RESULTS | ./transportdirect-journeys-to-grid grid $RECT $SIZE_PX $SIZE_PX 1 900 > $DIR/$RESULTS-grid
cat $DIR/$RESULTS-grid | ./grid-to-ppm field $RECT $SIZE_PX $SIZE_PX > $DIR/$RESULTS.ppm

convert $DIR/$RESULTS.ppm $DIR/$RESULTS.png
eog $DIR/$RESULTS.png

