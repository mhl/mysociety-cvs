#!/bin/bash
# test-run:
# Test code for Contours of Life etc.
#
# Copyright (c) 2009 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#

set -x

set -e
. ../../shlib/deployfns
read_conf ../conf/general
cd ../

OXFORD_CIFS="$OPTION_NPTDR_DATA/Timetable Data/CIF/Admin_Area_340/*.zip"
TMP_OUTPUT=/tmp/iso-test-run-$RANDOM$RANDOM$RANDOM

# check PostGIS does OSGB transform correctly

#echo "select AsText(ST_Transform(ST_SetSRID(GeomFromText('POINT(-1.78103 51.09168)'), 4326) , 27700));" | psql --host $OPTION_COL_DB_HOST --port $OPTION_COL_DB_PORT -A -F " " $OPTION_COL_DB_NAME $OPTION_COL_DB_USER

# http://www.nabble.com/SRID-tranformations-(OSGB-1936)-td20096957.html

# test atcocif.py
cd ../pylib/mysociety
nosetests
cd ../../iso/pylib
nosetests
cd ../tiles
#nosetests # reenable when pyproj packages ready
cd ..

# compare C++ and Python planner on Oxford NPTDR data set
cd pylib
make all
cd ../bin
mkdir $TMP_OUTPUT
# ... run C++ planner
./do-nptdr.py --config=../conf/oxford-test --data="$OXFORD_CIFS" --output=$TMP_OUTPUT fastcalc
./do-nptdr.py --config=../conf/oxford-test --data="$OXFORD_CIFS" --output=$TMP_OUTPUT --makeplanbin="../pylib/makeplan-with-route" fastplan
# ... run Python planner
./do-nptdr.py --config=../conf/oxford-test --data="$OXFORD_CIFS" --output=$TMP_OUTPUT slowplan
# don't compare the full routes (they can contain differences when two journeys
# between the same two places take the same amount of time), just the times in
# minutes.
egrep "^From " $TMP_OUTPUT/nptdr-slow-9100OXFD-40000-human.txt >$TMP_OUTPUT/slow-routes.txt
egrep "^From " $TMP_OUTPUT/nptdr-fast-9100OXFD-40000-human.txt >$TMP_OUTPUT/fast-routes.txt
if ! diff -u $TMP_OUTPUT/slow-routes.txt $TMP_OUTPUT/fast-routes.txt
then
    echo "Failed test - C++ and Python planners differ in output, see in $TMP_OUTPUT/{slow,fast}-routes.txt"
    exit 1
fi
#rm -fr $TMP_OUTPUT



