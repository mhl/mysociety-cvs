#!/bin/bash
# test-run:
# Test code for Contours of Life etc.
#
# Copyright (c) 2009 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#

#set -x

set -e
. ../../shlib/deployfns
read_conf ../conf/general
cd ../

OXFORD_CIFS="$OPTION_NPTDR_DATA/Timetable Data/CIF/Admin_Area_340/*.zip"
TMP_OUTPUT=/tmp/iso-test-run-$RANDOM$RANDOM$RANDOM

# test atcocif loader
cd ../pylib/mysociety
nosetests --with-doctest
# test common iso modules
cd ../../iso/pylib
nosetests --with-doctest
# test tile code
cd ../tiles
#nosetests --with-doctest # reenable when pyproj packages ready
# test web
cd ../web
./test.py

# compare C++ and Python planner on Oxford NPTDR data set
cd bin
make --quiet all
mkdir $TMP_OUTPUT
# ... run C++ planner
./do-nptdr.py --config=../conf/oxford-test --data="$OXFORD_CIFS" --output=$TMP_OUTPUT fastcalc
./do-nptdr.py --config=../conf/oxford-test --data="$OXFORD_CIFS" --output=$TMP_OUTPUT --fastplanbin="../bin/fastplan" fastplan
# ... run Python planner
./do-nptdr.py --config=../conf/oxford-test --data="$OXFORD_CIFS" --output=$TMP_OUTPUT slowplan --loglevel=INFO
# don't compare the full routes (they can contain differences when two journeys
# between the same two places take the same amount of time), just the times in
# minutes.
egrep "^From " $TMP_OUTPUT/nptdr-slow-9100OXFD-40000-human.txt | sort >$TMP_OUTPUT/slow-routes.txt
egrep "^From " $TMP_OUTPUT/nptdr-fast-9100OXFD-40000-human.txt | sort >$TMP_OUTPUT/fast-routes.txt
if ! diff -u $TMP_OUTPUT/slow-routes.txt $TMP_OUTPUT/fast-routes.txt
then
    echo "Failed test - C++ and Python planners differ in output, see in $TMP_OUTPUT/{slow,fast}-routes.txt"
    exit 1
fi
rm -fr $TMP_OUTPUT



