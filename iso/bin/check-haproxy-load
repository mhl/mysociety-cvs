#!/usr/bin/python
#
# check-haproxy-load:
# See if overloaded.
#
# Copyright (c) 2009 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: check-haproxy-load,v 1.1 2009-05-20 01:31:45 francis Exp $
#

import sys
sys.path.extend((sys.path[0]+"/../pylib", sys.path[0]+"/../../pylib"))
import os
import re
import urllib2

import mysociety.config
mysociety.config.set_file(sys.path[0]+"/../conf/general")

from page import random_token, send_template_email

import coldb
db = coldb.get_cursor()

url = mysociety.config.get('BASE_URL') + 'haproxy_stats'
try:
    stats = urllib2.urlopen(url).read()
except urllib2.HTTPError, e:
    # on test sites etc. no haproxy
    if e.code == 404:
        sys.exit()
    raise

matches = re.search("current conns = ([0-9]+)", stats)
current_connections = matches.groups()[0]

max_connections = mysociety.config.get('MAX_HAPROXY_CONNECTIONS')
if current_connections > max_connections:
    allow_new_maps = False
else:
    allow_new_maps = True

print allow_new_maps

db.execute('UPDATE allow_new_map SET state=%s', (allow_new_maps,))
db.execute('COMMIT')



